# KEEmulator

**KEEmulator** — это эмулятор командной строки UNIX-подобной операционной системы. Он имитирует работу терминала в изолированной среде: все операции с файлами происходят в виртуальной файловой системе (VFS) в памяти. Проект разработан как учебный прототип, эволюционирующий по этапам, с поддержкой базовых команд, навигации, логирования и тестов через скрипты.

Цель: Создать минималистичный CLI-интерфейс для практики команд shell.

## Описание

KEEmulator загружает структуру файловой системы из JSON-файла (VFS), предоставляет интерактивный REPL (Read-Eval-Print Loop) для ввода команд и поддерживает выполнение стартовых скриптов. Команды работают только с VFS в RAM — изменения (копирование, удаление) не сохраняются на диск.

- **Ключевые особенности**:
  - Поддержка базовых команд: `ls`, `cd`, `cat`, `pwd`, `tree`, `uniq`, `who`, `cp`, `rm`, `exit`.
  - VFS на основе JSON с поддержкой base64 для бинарных файлов.
  - Логирование событий в CSV-формат.
  - Автоматизированное выполнение скриптов с имитацией интерактивного ввода.
  - Обработка ошибок в стиле UNIX (например, "No such file or directory").

Проект следует принципам этапов разработки, чтобы постепенно наращивать функциональность от простого прототипа до полного эмулятора.

## Установка

### Требования
- Python 3.8+ (тестировано на 3.12).
- Стандартные библиотеки: `json`, `argparse`, `shlex`, `copy`, `base64`, `datetime`, `logging`, `os`.

### Клонирование и запуск
1. Клонируйте репозиторий (или скопируйте файлы):
   ```
   git clone <repo-url>
   cd KEEmulator
   ```
2. Убедитесь, что файлы VFS (JSON) и скрипты (.txt) в той же директории.
3. Запустите (см. раздел "Запуск" ниже).

## Запуск

Эмулятор запускается через CLI с опциональными параметрами:

```bash
python main_KEEmulator.py --vfs_path=<path_to_vfs.json> --log_path=<log_file.csv> --script_path=<startup_script.txt>
```

- `--vfs_path`: Путь к JSON-файлу VFS (обязательно для команд с файлами).
- `--log_path`: Путь к лог-файлу (CSV с колонками: timestamp, username, command, result).
- `--script_path`: Путь к стартовому скрипту (выполняется перед интерактивным режимом).

### Примеры запусков
- **Минимальный тест (простая VFS)**:
  ```bash
  python main_KEEmulator.py --vfs_path=simpleVFS.json --log_path=emulator.log --script_path=script1.txt
  ```
  - Загружает простую VFS с одним файлом.
  - Выполняет скрипт: навигация, ls, cat, tree.

- **Расширенный тест (с ошибками)**:
  ```bash
  python main_KEEmulator.py --vfs_path=advancedVFS.json --log_path=emulator.log --script_path=script2.txt
  ```
  - Тестирует обработку ошибок (неверные пути).

- **Полный тест (все команды)**:
  ```bash
  python main_KEEmulator.py --vfs_path=advancedVFS.json --log_path=emulator.log --script_path=test_script.txt
  ```
  - Полный сценарий: навигация, файлы, ошибки, uniq/who, cp/rm, tree.

После скрипта (если указан) переходит в интерактивный режим. Для выхода: `exit` или Ctrl+C (с подсказкой).

## Поддерживаемые команды

Все команды имитируют поведение UNIX-shell. Аргументы: абсолютные (`/path`) или относительные (от текущей директории). Ошибки выводятся в стиле `command: path: Error message`.

| Команда | Описание | Аргументы | Пример |
|---------|----------|-----------|--------|
| `ls` | Список файлов/папок в директории. Папки с `/`. | Опционально: путь. | `ls /home` → `user/` |
| `cd` | Смена текущей директории. | Обязательно: путь (по умолчанию `/`). | `cd home` → `/home` |
| `cat` | Вывод содержимого файла (с декодированием base64). | Обязательно: путь к файлу. | `cat notes.txt` → "Important notes..." |
| `pwd` | Текущий путь. | Нет. | `/home/user` |
| `tree` | Древовидный вид структуры (ASCII-арт). | Опционально: путь к папке. | `tree /` → root/\n├── home/... |
| `uniq` | Удаление дублирующихся соседних строк из файла. | Обязательно: путь к файлу. | `uniq notes.txt` → Уникальные строки |
| `who` | Информация о текущем пользователе (одна строка). | Игнорирует аргументы. | `who` → "user pts/0 2025-10-11 12:00" |
| `cp` | Копирование файла (только файлы, без перезаписи). | Обязательно: src dest. | `cp notes.txt copy.txt` → "Copied..." |
| `rm` | Удаление файла (только файлы). | Обязательно: путь к файлу. | `rm copy.txt` → "Removed..." |
| `exit` | Выход из эмулятора. | Нет. | `exit` → Завершение |

## Структура файлов

- **main_KEEmulator.py**: Основной вход. Парсит аргументы, загружает VFS/лог/скрипт, запускает REPL.
- **utils.py**: Вспомогательные функции (аргументы, логирование, prompt: `user@host:path$ `).
- **vfs.py**: VFS-логика (загрузка JSON, поиск узлов, текущий путь).
- **commands.py**: Парсинг и выполнение команд (не полностью дан, но интегрирован).
- **script_runner.py**: Выполнение стартовых скриптов (имитация ввода, обработка ошибок).
- **VFS-файлы**:
  - `simpleVFS.json`: Минимальная структура (root с одним файлом).
  - `advancedVFS.json`: Полная (home/user/documents, etc, binary.dat).
- **Скрипты тестов**:
  - `script1.txt`: Базовый тест навигации/cat/tree.
  - `script2.txt`: Тест ошибок.
  - `test_script.txt`: Полный тест всех команд (включая cp/rm, uniq/who).

## Этапы разработки

Проект построен по 5 этапам для постепенного роста:

1. **REPL (Прототип)**: Базовый CLI с prompt, парсингом (shlex для кавычек), заглушками для `ls`/`cd`, `exit`. Демонстрация: интерактивный ввод/ошибки.
2. **Конфигурация**: Аргументы CLI (argparse), CSV-логи (username, command, result), runner для скриптов (имитация диалога).
3. **VFS**: Загрузка JSON в память, навигация (`find_vfs_node`), команды `cat`/`pwd`/`tree`. Тесты с разными VFS.
4. **Основные команды**: Реализация `ls`/`cd`, добавление `uniq`/`who`. Тест-скрипт с примерами/ошибками.
5. **Дополнительные команды**: `cp` (deepcopy), `rm` (удаление из children). Полный тест с модификациями VFS.

## Тестирование

- **Автоматизированные**: Используйте скрипты (.txt) с `--script_path`. Они пропускают комментарии (#), выводят prompt + команду + результат.
- **Интерактивный**: Запуск без скрипта — вводите команды вручную.
- **Проверка логов**: Откройте `emulator.log` (CSV) для анализа событий.
- **Пример теста**: В `test_script.txt` — все сценарии, включая ошибки и изменения VFS (проверьте `tree` до/после `cp`/`rm`).

## Логирование

- Формат: `timestamp,username,"command","result"`.
- Пример: `2025-10-11 12:00:00,user,"ls","etc/  binary.dat"`.
- Ошибки: Логируются как "ERROR: message".
- Настройка: Только если `--log_path` указан (setup_logging в utils.py).